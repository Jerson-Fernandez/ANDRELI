<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Control de Pagos</title>
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Control Pagos">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#667eea">
    
    <!-- Prevent zoom on input focus -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            min-height: 100vh;
            overflow-x: hidden;
            /* Prevent pull-to-refresh on iOS */
            overscroll-behavior: contain;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            /* Safe area for iPhone notch */
            padding-top: max(20px, env(safe-area-inset-top));
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
        }

        .container {
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
            /* Safe area for iPhone bottom */
            padding-bottom: max(20px, env(safe-area-inset-bottom));
        }

        .stats-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .payment-method {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            margin-left: 8px;
        }

        .method-efectivo {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .method-yape {
            background: #e3f2fd;
            color: #1565c0;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 10px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            width: 100%;
            cursor: pointer;
            transition: transform 0.2s;
            margin-bottom: 15px;
            /* Prevent iOS button styling */
            -webkit-appearance: none;
            appearance: none;
        }

        .btn-primary:active {
            transform: scale(0.98);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.2s;
            -webkit-appearance: none;
            appearance: none;
        }

        .btn-secondary:active {
            background: #e0e0e0;
        }

        .client-list {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .client-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.2s;
        }

        .client-item:active {
            background: #f9f9f9;
        }

        .client-item:last-child {
            border-bottom: none;
        }

        .client-name {
            font-weight: 500;
            color: #333;
        }

        .client-status {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: 500;
        }

        .status-paid {
            background: #d4edda;
            color: #155724;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            margin: 50px auto;
            padding: 20px;
            width: 90%;
            max-width: 500px;
            border-radius: 15px;
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
        }

        .close-btn {
            font-size: 24px;
            cursor: pointer;
            color: #999;
            background: none;
            border: none;
            -webkit-appearance: none;
            appearance: none;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border 0.2s;
            -webkit-appearance: none;
            appearance: none;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .payment-history {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .payments-container {
            max-height: 320px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .payment-item {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
        }

        .payment-item:last-child {
            border-bottom: none;
        }

        .payment-client {
            font-weight: 500;
            color: #333;
        }

        .payment-details {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
            font-size: 14px;
            color: #666;
        }

        .payment-amount {
            color: #28a745;
            font-weight: 600;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .search-container {
            margin-bottom: 15px;
        }

        .search-input {
            margin-bottom: 0;
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
        }

        .search-input:focus {
            background: white;
            border-color: #667eea;
        }

        .client-item.hidden {
            display: none;
        }

        .client-dropdown {
            position: absolute;
            background: white;
            border: 1px solid #e0e0e0;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1001;
            width: 100%;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .dropdown-item {
            padding: 12px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.2s;
        }

        .dropdown-item:hover {
            background: #f8f9fa;
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item-name {
            font-weight: 500;
            color: #333;
        }

        .dropdown-item-phone {
            font-size: 12px;
            color: #666;
            margin-top: 2px;
        }

        .form-group {
            margin-bottom: 20px;
            position: relative;
        }

        .clients-container {
            max-height: 320px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .no-results {
            text-align: center;
            padding: 20px;
            color: #999;
            font-style: italic;
        }

        .date-filter {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            margin-left: 10px;
            -webkit-appearance: none;
            appearance: none;
        }

        .btn-danger:active {
            background: #c82333;
        }

        .frequency-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            margin-left: 5px;
        }

        .freq-diario {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .freq-semanal {
            background: #e3f2fd;
            color: #1565c0;
        }

        .freq-quincenal {
            background: #fce4ec;
            color: #c2185b;
        }

        .freq-mensual {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        /* Estilos para WhatsApp y llamadas */
        .whatsapp-btn {
            background: #25D366;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 50%;
            font-size: 16px;
            cursor: pointer;
            margin-left: 8px;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s, transform 0.2s;
            -webkit-appearance: none;
            appearance: none;
        }

        .whatsapp-btn:active {
            background: #128C7E;
            transform: scale(0.95);
        }

        .call-btn {
            background: #007AFF;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 50%;
            font-size: 16px;
            cursor: pointer;
            margin-left: 8px;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s, transform 0.2s;
            -webkit-appearance: none;
            appearance: none;
        }

        .call-btn:active {
            background: #0056CC;
            transform: scale(0.95);
        }

        .client-actions {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* iOS specific styles */
        @supports (-webkit-overflow-scrolling: touch) {
            .payments-container {
                -webkit-overflow-scrolling: touch;
            }
            .clients-container {
                -webkit-overflow-scrolling: touch;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Control de Pagos</h1>
    </div>

    <div class="container">
        <!-- Filtro de fecha -->
        <div class="date-filter">
            <div>
                <label for="dateFilter" class="form-label">Fecha:</label>
                <input type="date" id="dateFilter" class="form-input" style="width: auto;">
            </div>
            <button class="btn-secondary" onclick="setToday()">Hoy</button>
        </div>

        <!-- EstadÃ­sticas del dÃ­a -->
        <div class="stats-card">
            <h2 class="section-title">Resumen del DÃ­a</h2>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value" id="totalPaid">S/0</div>
                    <div class="stat-label">Total Recibido</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="clientsPaid">0</div>
                    <div class="stat-label">Clientes que Pagaron</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalCash">S/0</div>
                    <div class="stat-label">ðŸ’µ Efectivo</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalYape">S/0</div>
                    <div class="stat-label">ðŸ“± Yape</div>
                </div>
            </div>
        </div>

        <!-- Botones principales -->
        <button class="btn-primary" onclick="showAddClientModal()">âž• Agregar Cliente</button>
        <button class="btn-primary" onclick="showAddPaymentModal()">ðŸ’° Registrar Pago</button>

        <!-- Lista de clientes -->
        <div class="client-list">
            <h2 class="section-title">Clientes del DÃ­a</h2>
            <div class="clients-container" id="clientsContainer">
                <div id="clientsList">
                    <div class="empty-state">No hay clientes registrados</div>
                </div>
            </div>
        </div>

        <!-- Historial de pagos -->
        <div class="payment-history">
            <h2 class="section-title">Pagos del DÃ­a</h2>
            <div class="payments-container" id="paymentsContainer">
                <div id="paymentsList">
                    <div class="empty-state">No hay pagos registrados</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Agregar Cliente -->
    <div id="addClientModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Agregar Cliente</h3>
                <button class="close-btn" onclick="closeModal('addClientModal')">&times;</button>
            </div>
            <form onsubmit="addClient(event)">
                <div class="form-group">
                    <label class="form-label">Nombre del Cliente</label>
                    <input type="text" class="form-input" id="clientName" required>
                </div>
                <div class="form-group">
                    <label class="form-label">TelÃ©fono (opcional)</label>
                    <input type="tel" class="form-input" id="clientPhone">
                </div>
                <div class="form-group">
                    <label class="form-label">Fecha de Desembolso</label>
                    <input type="date" class="form-input" id="clientDisbursementDate" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Frecuencia de Pago</label>
                    <select class="form-input" id="clientFrequency" required>
                        <option value="">Seleccionar frecuencia...</option>
                        <option value="DIARIO">Diario</option>
                        <option value="SEMANAL">Semanal</option>
                        <option value="QUINCENAL">Quincenal</option>
                        <option value="MENSUAL">Mensual</option>
                    </select>
                </div>
                <button type="submit" class="btn-primary">Agregar Cliente</button>
            </form>
        </div>
    </div>

    <!-- Modal Registrar Pago -->
    <div id="addPaymentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Registrar Pago</h3>
                <button class="close-btn" onclick="closeModal('addPaymentModal')">&times;</button>
            </div>
            <form onsubmit="addPayment(event)">
                <div class="form-group">
                    <label class="form-label">Cliente</label>
                    <input type="text" 
                           class="form-input" 
                           id="clientSearchModal" 
                           placeholder="ðŸ” Buscar y seleccionar cliente..."
                           autocomplete="off"
                           onkeyup="filterModalClients()"
                           onfocus="showClientDropdown()"
                           required>
                    <input type="hidden" id="selectedClientId" required>
                    <div id="clientDropdown" class="client-dropdown" style="display: none;">
                        <!-- AquÃ­ se mostrarÃ¡n los clientes filtrados -->
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Monto</label>
                    <input type="number" class="form-input" id="paymentAmount" step="0.01" required>
                </div>
                <div class="form-group">
                    <label class="form-label">MÃ©todo de Pago</label>
                    <select class="form-input" id="paymentMethod" required>
                        <option value="">Seleccionar mÃ©todo...</option>
                        <option value="efectivo">ðŸ’µ Efectivo</option>
                        <option value="yape">ðŸ“± Yape</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Nota (opcional)</label>
                    <input type="text" class="form-input" id="paymentNote">
                </div>
                <button type="submit" class="btn-primary">Registrar Pago</button>
            </form>
        </div>
    </div>

    <script>
        // Estado de la aplicaciÃ³n
        let clients = [];
        let payments = [];

        // FunciÃ³n para obtener la fecha y hora en zona horaria peruana (UTC-5)
        function getPeruvianDate(date = new Date()) {
            // Obtener la fecha en zona horaria de PerÃº usando toLocaleString
            const peruTime = new Date(date.toLocaleString("en-US", {timeZone: "America/Lima"}));
            return peruTime;
        }

        // FunciÃ³n para obtener solo la fecha en formato YYYY-MM-DD en horario peruano
        function getPeruvianDateString(date = new Date()) {
            // Crear fecha en zona horaria de Lima, PerÃº
            const options = {
                timeZone: 'America/Lima',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            };
            const peruDateStr = date.toLocaleDateString('en-CA', options); // 'en-CA' da formato YYYY-MM-DD
            return peruDateStr;
        }

        // FunciÃ³n para obtener fecha y hora completa en formato ISO pero en horario peruano
        function getPeruvianISOString(date = new Date()) {
            // Usar la zona horaria de Lima para obtener la fecha/hora correcta
            return new Date(date.toLocaleString("en-US", {timeZone: "America/Lima"})).toISOString();
        }

        // FunciÃ³n para formatear hora en horario peruano
        function formatPeruvianTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleTimeString('es-PE', {
                timeZone: 'America/Lima',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        // FunciÃ³n para formatear fecha en horario peruano
        function formatPeruvianDate(dateString) {
            const date = new Date(dateString + 'T00:00:00');
            return date.toLocaleDateString('es-PE', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        }

        // FunciÃ³n para abrir WhatsApp
        function openWhatsApp(phone) {
            if (!phone || phone.trim() === '') {
                alert('Este cliente no tiene nÃºmero de telÃ©fono registrado');
                return;
            }
            
            // Limpiar el nÃºmero de telÃ©fono (quitar espacios, guiones, parÃ©ntesis)
            let cleanPhone = phone.replace(/\s+/g, '').replace(/[-()]/g, '');
            
            // Si el nÃºmero no comienza con +51, agregarlo (cÃ³digo de paÃ­s de PerÃº)
            if (!cleanPhone.startsWith('+51') && !cleanPhone.startsWith('51')) {
                cleanPhone = '+51' + cleanPhone;
            } else if (cleanPhone.startsWith('51') && !cleanPhone.startsWith('+51')) {
                cleanPhone = '+' + cleanPhone;
            }
            
            // Crear URL de WhatsApp sin mensaje
            const whatsappUrl = `https://wa.me/${cleanPhone.replace('+', '')}`;
            
            // Abrir WhatsApp
            window.open(whatsappUrl, '_blank');
        }

        // FunciÃ³n para hacer llamada telefÃ³nica
        function makeCall(phone) {
            if (!phone || phone.trim() === '') {
                alert('Este cliente no tiene nÃºmero de telÃ©fono registrado');
                return;
            }
            
            // Limpiar el nÃºmero de telÃ©fono (quitar espacios, guiones, parÃ©ntesis)
            let cleanPhone = phone.replace(/\s+/g, '').replace(/[-()]/g, '');
            
            // Si el nÃºmero no comienza con +51, agregarlo (cÃ³digo de paÃ­s de PerÃº)
            if (!cleanPhone.startsWith('+51') && !cleanPhone.startsWith('51')) {
                cleanPhone = '+51' + cleanPhone;
            } else if (cleanPhone.startsWith('51') && !cleanPhone.startsWith('+51')) {
                cleanPhone = '+' + cleanPhone;
            }
            
            // Crear URL para llamada
            const callUrl = `tel:${cleanPhone}`;
            
            // Abrir aplicaciÃ³n de llamadas
            window.location.href = callUrl;
        }

        // Clientes del Excel
        const excelClients = [
            {id: "3524", name: "DE LA PUENTE FLORES, NANCY", phone: "990441351", disbursementDate: "2025-05-30", frequency: "DIARIO"},
            {id: "7495", name: "GAMARRA ACOSTA, NARCISO", phone: "915203130", disbursementDate: "2025-06-18", frequency: "SEMANAL"},
            {id: "7805", name: "RODRIGUEZ SEGURA, GENRI", phone: "937680754", disbursementDate: "2025-06-18", frequency: "SEMANAL"},
            {id: "19179", name: "BRAVO TRUJILLO, DELIA", phone: "965108551", disbursementDate: "2025-06-17", frequency: "SEMANAL"},
            {id: "22074", name: "PALABACINO BRANDAN, JULIANA", phone: "918893603", disbursementDate: "2025-05-30", frequency: "DIARIO"},
            {id: "22426", name: "ALVARADO VERDE, ARTURO PERCY", phone: "938134663", disbursementDate: "2024-11-29", frequency: "SEMANAL"},
            {id: "22926", name: "ADAN ULPIANO, JUAN FILOMON", phone: "990004715", disbursementDate: "2024-12-03", frequency: "MENSUAL"},
            {id: "23695", name: "AROSTEGUI MARTINEZ, JOSE FRANCISCO", phone: "940164878", disbursementDate: "2025-05-21", frequency: "SEMANAL"},
            {id: "23912", name: "RAMIREZ CHACALTANA, CESAR LUCIANO", phone: "992413952", disbursementDate: "2025-06-30", frequency: "DIARIO"},
            {id: "23976", name: "CAMPOS DEZA, DANIEL", phone: "956363967", disbursementDate: "2025-06-13", frequency: "SEMANAL"},
            {id: "24297", name: "HERRERA PRESENTACION, PERCY JONATHAN", phone: "943298683", disbursementDate: "2025-06-20", frequency: "MENSUAL"},
            {id: "24390", name: "GARIBAY ALVARADO, MIROSLAVA", phone: "943694037", disbursementDate: "2025-06-25", frequency: "SEMANAL"},
            {id: "24437", name: "NAVARRETE RAMOS, MARIA ELENA", phone: "993619795", disbursementDate: "2025-06-11", frequency: "DIARIO"},
            {id: "24929", name: "TARAZONA SALVADOR, SAMANTHA KORAIMA", phone: "935220939", disbursementDate: "2025-06-18", frequency: "DIARIO"},
            {id: "24983", name: "ORTEGA PONTE, JULIANA KAROLL", phone: "935313986", disbursementDate: "2025-06-13", frequency: "SEMANAL"},
            {id: "25030", name: "ROSALES HUAYNATE, YOLY JUDITH", phone: "927618853", disbursementDate: "2025-07-02", frequency: "SEMANAL"},
            {id: "25060", name: "CENEPO AROSTEGUI, LOURDES", phone: "935530927", disbursementDate: "2025-05-28", frequency: "DIARIO"},
            {id: "25086", name: "VERAMENDI VARGAS DE DAVILA, ANGELA LEYDI", phone: "934363562", disbursementDate: "2025-06-30", frequency: "SEMANAL"},
            {id: "25132", name: "MARQUEZ FLORES, JOHAN ANTONNY", phone: "989851759", disbursementDate: "2025-05-30", frequency: "SEMANAL"},
            {id: "25159", name: "PINEDO PUTPAÃ‘A, PATRICIA ALFONSA", phone: "961690993", disbursementDate: "2025-06-16", frequency: "DIARIO"},
            {id: "25236", name: "UPIACHIHUA PEÃ‘A, RICHARD ALBERTO", phone: "917955821", disbursementDate: "2025-06-13", frequency: "DIARIO"},
            {id: "25295", name: "ROMERO BERAUN, DORA", phone: "921090751", disbursementDate: "2025-06-20", frequency: "DIARIO"},
            {id: "25310", name: "RIVERA BRAVO, LIZ MARLENE", phone: "971953669", disbursementDate: "2025-06-20", frequency: "DIARIO"},
            {id: "25325", name: "RODRIGUEZ SANGAMA, EDWIN", phone: "989956833", disbursementDate: "2025-06-18", frequency: "SEMANAL"},
            {id: "18636", name: "HIJAR REATEGUI, JHONEL ROY", phone: "928894109", disbursementDate: "2024-12-03", frequency: "MENSUAL"},
            {id: "12640", name: "GRIFO INVERSIONES GARCIA SOCIEDAD COMERCIAL DE RESPONSABILIDAD LIMITADA", phone: "953268928", disbursementDate: "2025-04-16", frequency: "QUINCENAL"}
        ];

        // Inicializar la app
        function init() {
            loadData();
            importExcelClients();
            setToday();
            updateDisplay();
            
            // Agregar evento para cerrar dropdown al hacer clic fuera
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.form-group')) {
                    hideClientDropdown();
                }
            });
        }

        // Importar clientes del Excel si no existen
        function importExcelClients() {
            const savedImport = localStorage.getItem('excelClientsImported');
            
            if (!savedImport) {
                excelClients.forEach(excelClient => {
                    // Verificar si el cliente ya existe
                    if (!clients.find(c => c.id === excelClient.id)) {
                        clients.push({
                            id: excelClient.id,
                            name: excelClient.name,
                            phone: excelClient.phone,
                            disbursementDate: excelClient.disbursementDate,
                            frequency: excelClient.frequency,
                            createdAt: getPeruvianISOString()
                        });
                    }
                });
                
                localStorage.setItem('excelClientsImported', 'true');
                saveData();
            }
        }

        // Verificar si un cliente debe pagar en una fecha especÃ­fica
        function shouldPayOnDate(client, checkDate) {
            if (!client.disbursementDate) {
                return false;
            }
            
            const disbursementDate = new Date(client.disbursementDate + 'T00:00:00');
            const targetDate = new Date(checkDate + 'T00:00:00');
            
            // Si la fecha de verificaciÃ³n es anterior al desembolso, no debe pagar
            if (targetDate < disbursementDate) {
                return false;
            }
            
            const daysDiff = Math.floor((targetDate - disbursementDate) / (1000 * 60 * 60 * 24));
            const dayOfWeek = targetDate.getDay(); // 0 = Domingo, 6 = SÃ¡bado
            
            switch(client.frequency) {
                case 'DIARIO':
                    // Solo de lunes a viernes
                    return dayOfWeek >= 1 && dayOfWeek <= 5;
                    
                case 'SEMANAL':
                    // Cada 7 dÃ­as desde el desembolso
                    return daysDiff % 7 === 0;
                    
                case 'QUINCENAL':
                    // Cada 15 dÃ­as desde el desembolso
                    return daysDiff % 15 === 0;
                    
                case 'MENSUAL':
                    // El mismo dÃ­a de cada mes
                    const disbursementDay = disbursementDate.getDate();
                    const targetDay = targetDate.getDate();
                    
                    // Si el dÃ­a del mes coincide
                    if (disbursementDay === targetDay) {
                        return true;
                    }
                    
                    // Si es fin de mes y el dÃ­a de desembolso es mayor que los dÃ­as del mes actual
                    const lastDayOfMonth = new Date(targetDate.getFullYear(), targetDate.getMonth() + 1, 0).getDate();
                    if (targetDay === lastDayOfMonth && disbursementDay > lastDayOfMonth) {
                        return true;
                    }
                    
                    return false;
                    
                default:
                    return false;
            }
        }

        // Cargar datos del localStorage
        function loadData() {
            const savedClients = localStorage.getItem('clients');
            const savedPayments = localStorage.getItem('payments');
            
            if (savedClients) clients = JSON.parse(savedClients);
            if (savedPayments) payments = JSON.parse(savedPayments);
        }

        // Guardar datos en localStorage
        function saveData() {
            localStorage.setItem('clients', JSON.stringify(clients));
            localStorage.setItem('payments', JSON.stringify(payments));
        }

        // Establecer fecha de hoy en horario peruano
        function setToday() {
            const today = getPeruvianDateString();
            document.getElementById('dateFilter').value = today;
            updateDisplay();
        }

        // Actualizar la visualizaciÃ³n
        function updateDisplay() {
            const selectedDate = document.getElementById('dateFilter').value;
            updateStats(selectedDate);
            updateClientsList(selectedDate);
            updatePaymentsList(selectedDate);
        }

        // Actualizar estadÃ­sticas
        function updateStats(date) {
            const dayPayments = payments.filter(p => p.date === date);
            const total = dayPayments.reduce((sum, p) => sum + p.amount, 0);
            const uniqueClients = new Set(dayPayments.map(p => p.clientId)).size;
            
            // Calcular totales por mÃ©todo de pago
            const cashTotal = dayPayments
                .filter(p => p.method === 'efectivo')
                .reduce((sum, p) => sum + p.amount, 0);
            
            const yapeTotal = dayPayments
                .filter(p => p.method === 'yape')
                .reduce((sum, p) => sum + p.amount, 0);

            document.getElementById('totalPaid').textContent = `S/${total.toFixed(2)}`;
            document.getElementById('clientsPaid').textContent = uniqueClients;
            document.getElementById('totalCash').textContent = `S/${cashTotal.toFixed(2)}`;
            document.getElementById('totalYape').textContent = `S/${yapeTotal.toFixed(2)}`;
        }

        // Actualizar lista de clientes
        function updateClientsList(date) {
            const clientsList = document.getElementById('clientsList');
            const dayPayments = payments.filter(p => p.date === date);
            
            // Filtrar clientes que deben pagar en la fecha seleccionada
            const clientsToPayToday = clients.filter(client => shouldPayOnDate(client, date));
            
            if (clientsToPayToday.length === 0) {
                clientsList.innerHTML = '<div class="empty-state">No hay clientes que deban pagar hoy</div>';
                return;
            }

            clientsList.innerHTML = clientsToPayToday.map(client => {
                const clientPayments = dayPayments.filter(p => p.clientId === client.id);
                const hasPaid = clientPayments.length > 0;
                const totalPaid = clientPayments.reduce((sum, p) => sum + p.amount, 0);

                const freqClass = {
                    'DIARIO': 'freq-diario',
                    'SEMANAL': 'freq-semanal',
                    'QUINCENAL': 'freq-quincenal',
                    'MENSUAL': 'freq-mensual'
                }[client.frequency];

                return `
                    <div class="client-item" onclick="showClientDetails('${client.id}')">
                        <div>
                            <div class="client-name">
                                ${client.name}
                                <span class="frequency-badge ${freqClass}">${client.frequency}</span>
                            </div>
                            ${hasPaid ? `<small>PagÃ³: S/${totalPaid.toFixed(2)}</small>` : ''}
                        </div>
                        <div class="client-actions">
                            <span class="client-status ${hasPaid ? 'status-paid' : 'status-pending'}">
                                ${hasPaid ? 'PagÃ³' : 'Pendiente'}
                            </span>
                            ${client.phone ? `
                            <button class="call-btn" onclick="makeCall('${client.phone}'); event.stopPropagation();" title="Llamar por telÃ©fono">
                                ðŸ“ž
                            </button>
                            <button class="whatsapp-btn" onclick="openWhatsApp('${client.phone}'); event.stopPropagation();" title="Abrir chat de WhatsApp">
                                ðŸ“±
                            </button>` : ''}
                            <button class="btn-danger" onclick="deleteClient('${client.id}', event)">Ã—</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Actualizar lista de pagos
        function updatePaymentsList(date) {
            const paymentsList = document.getElementById('paymentsList');
            const dayPayments = payments.filter(p => p.date === date);
            
            if (dayPayments.length === 0) {
                paymentsList.innerHTML = '<div class="empty-state">No hay pagos registrados</div>';
                return;
            }

            paymentsList.innerHTML = dayPayments
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                .map(payment => {
                    const client = clients.find(c => c.id === payment.clientId);
                    const methodIcon = payment.method === 'yape' ? 'ðŸ“±' : 'ðŸ’µ';
                    const methodClass = payment.method === 'yape' ? 'method-yape' : 'method-efectivo';
                    const methodText = payment.method === 'yape' ? 'Yape' : 'Efectivo';
                    
                    return `
                        <div class="payment-item">
                            <div class="payment-client">
                                ${client ? client.name : 'Cliente eliminado'}
                                <span class="payment-method ${methodClass}">${methodIcon} ${methodText}</span>
                            </div>
                            <div class="payment-details">
                                <span>${payment.note || 'Sin nota'}</span>
                                <span class="payment-amount">S/${payment.amount.toFixed(2)}</span>
                            </div>
                            <div class="payment-details">
                                <span>${formatPeruvianTime(payment.timestamp)}</span>
                                <button class="btn-danger" onclick="deletePayment('${payment.id}')">Eliminar</button>
                            </div>
                        </div>
                    `;
                }).join('');
        }

        // Mostrar dropdown de clientes
        function showClientDropdown() {
            const dropdown = document.getElementById('clientDropdown');
            dropdown.style.display = 'block';
            filterModalClients();
        }

        // Ocultar dropdown de clientes
        function hideClientDropdown() {
            const dropdown = document.getElementById('clientDropdown');
            dropdown.style.display = 'none';
        }

        // Filtrar clientes en el modal
        function filterModalClients() {
            const searchTerm = document.getElementById('clientSearchModal').value.toLowerCase();
            const dropdown = document.getElementById('clientDropdown');
            
            const filteredClients = clients.filter(client => 
                client.name.toLowerCase().includes(searchTerm) ||
                (client.phone && client.phone.includes(searchTerm))
            );

            if (filteredClients.length === 0) {
                dropdown.innerHTML = '<div class="no-results">No se encontraron clientes</div>';
            } else {
                dropdown.innerHTML = filteredClients.map(client => `
                    <div class="dropdown-item" onclick="selectClient('${client.id}', '${client.name}')">
                        <div class="dropdown-item-name">${client.name}</div>
                        ${client.phone ? `<div class="dropdown-item-phone">${client.phone}</div>` : ''}
                    </div>
                `).join('');
            }
        }

        // Seleccionar cliente del dropdown
        function selectClient(clientId, clientName) {
            document.getElementById('selectedClientId').value = clientId;
            document.getElementById('clientSearchModal').value = clientName;
            hideClientDropdown();
        }

        // Mostrar modal
        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        // Cerrar modal
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            // Limpiar campos del modal de pago
            if (modalId === 'addPaymentModal') {
                document.getElementById('clientSearchModal').value = '';
                document.getElementById('selectedClientId').value = '';
                hideClientDropdown();
            }
        }

        // Mostrar modal de agregar cliente
        function showAddClientModal() {
            document.getElementById('clientName').value = '';
            document.getElementById('clientPhone').value = '';
            document.getElementById('clientDisbursementDate').value = '';
            document.getElementById('clientFrequency').value = '';
            showModal('addClientModal');
        }

        // Mostrar modal de agregar pago
        function showAddPaymentModal() {
            if (clients.length === 0) {
                alert('Primero debes agregar al menos un cliente');
                return;
            }
            document.getElementById('clientSearchModal').value = '';
            document.getElementById('selectedClientId').value = '';
            document.getElementById('paymentAmount').value = '';
            document.getElementById('paymentMethod').value = '';
            document.getElementById('paymentNote').value = '';
            showModal('addPaymentModal');
        }

        // Agregar cliente
        function addClient(event) {
            event.preventDefault();
            
            const name = document.getElementById('clientName').value.trim();
            const phone = document.getElementById('clientPhone').value.trim();
            const disbursementDate = document.getElementById('clientDisbursementDate').value;
            const frequency = document.getElementById('clientFrequency').value;
            
            const newClient = {
                id: Date.now().toString(),
                name: name,
                phone: phone,
                disbursementDate: disbursementDate,
                frequency: frequency,
                createdAt: getPeruvianISOString()
            };
            
            clients.push(newClient);
            saveData();
            updateDisplay();
            closeModal('addClientModal');
        }

        // Agregar pago
        function addPayment(event) {
            event.preventDefault();
            
            const clientId = document.getElementById('selectedClientId').value;
            const amount = parseFloat(document.getElementById('paymentAmount').value);
            const method = document.getElementById('paymentMethod').value;
            const note = document.getElementById('paymentNote').value.trim();
            const date = document.getElementById('dateFilter').value;
            
            if (!clientId) {
                alert('Por favor selecciona un cliente de la lista');
                return;
            }
            
            const newPayment = {
                id: Date.now().toString(),
                clientId: clientId,
                amount: amount,
                method: method,
                note: note,
                date: date,
                timestamp: getPeruvianISOString()
            };
            
            payments.push(newPayment);
            saveData();
            updateDisplay();
            closeModal('addPaymentModal');
        }

        // Eliminar cliente
        function deleteClient(clientId, event) {
            event.stopPropagation();
            if (confirm('Â¿EstÃ¡s seguro de eliminar este cliente? Se mantendrÃ¡n los pagos histÃ³ricos.')) {
                clients = clients.filter(c => c.id !== clientId);
                saveData();
                updateDisplay();
            }
        }

        // Eliminar pago
        function deletePayment(paymentId) {
            if (confirm('Â¿EstÃ¡s seguro de eliminar este pago?')) {
                payments = payments.filter(p => p.id !== paymentId);
                saveData();
                updateDisplay();
            }
        }

        // Mostrar detalles del cliente
        function showClientDetails(clientId) {
            const client = clients.find(c => c.id === clientId);
            const clientPayments = payments.filter(p => p.clientId === clientId);
            const totalPaid = clientPayments.reduce((sum, p) => sum + p.amount, 0);
            
            let nextPaymentDate = 'N/A';
            if (client.disbursementDate) {
                const today = getPeruvianDate();
                const tomorrow = new Date(today);
                tomorrow.setDate(tomorrow.getDate() + 1);
                
                // Buscar la prÃ³xima fecha de pago
                for (let i = 0; i < 60; i++) { // Buscar en los prÃ³ximos 60 dÃ­as
                    const checkDate = new Date(tomorrow);
                    checkDate.setDate(checkDate.getDate() + i);
                    
                    if (shouldPayOnDate(client, checkDate.toISOString().split('T')[0])) {
                        nextPaymentDate = checkDate.toLocaleDateString('es-PE');
                        break;
                    }
                }
            }
            
            alert(`Cliente: ${client.name}\nID: ${client.id}\nTelÃ©fono: ${client.phone || 'No registrado'}\nFecha de desembolso: ${client.disbursementDate ? formatPeruvianDate(client.disbursementDate) : 'N/A'}\nFrecuencia: ${client.frequency || 'N/A'}\nPrÃ³ximo pago: ${nextPaymentDate}\n\nTotal pagado (histÃ³rico): S/${totalPaid.toFixed(2)}\nNÃºmero de pagos: ${clientPayments.length}`);
        }

        // Event listener para cambio de fecha
        document.getElementById('dateFilter').addEventListener('change', updateDisplay);

        // Cerrar modales al hacer clic fuera
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }

        // Prevenir zoom en iOS cuando se hace focus en inputs
        document.addEventListener('touchstart', function(e) {
            if (e.touches.length > 1) {
                e.preventDefault();
            }
        });

        // Inicializar la aplicaciÃ³n
        init();
    </script>
</body>
</html>
